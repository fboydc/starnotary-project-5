<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Star Notary</title>
        <link rel="stylesheet" type="text/css" href="style.css">

        <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
        <script src="smart_contracts/Star.js"></script>
        
    </head>

    <body>
        <div class="container">

            <h1>Star Notary System - Buy or Create a Star with Ether</h1>
            <div class="row">
                <ul id="star_list">
                    <li id="list_title"><strong>STAR IDS:</strong></li>
                </ul>
                <div id="star_info">
                    <p>Name: <span id="star_name" class="red-text">NO STAR SELECTED</span></p>
                    <p id="star_story"></p>
                    <p>
                        <p><strong id="coords_title"></strong></p>
                        <p id="star_dec" class="red-text"></p>
                        <p id="star_mag" class="red-text"></p>
                        <p id="star_cent" class="red-text"></p>
                    </p>                 
                </div>
                <div id="new_star_menu">
                        <p>Create new Star</p>
                        <div class="form_row">
                            <label for="star_id_input" class="form_label">ID:</label>
                            <input type="text" name="star_id_input" id="star_id_input">
                        </div>
                        <div class="form_row">
                            <label for="star_name_input" class="form_label">Star Name:</label>
                            <input type="text" name="star_name_input" id="star_name_input">
                        </div>
                        <div class="form_row">
                                <label for="star_dec_input" class="form_label">Star Dec:</label>
                                <input type="text" name="star_dec_input" id="star_dec_input">
                        </div>
                        <div class="form_row">
                                <label for="star_mag_input" class="form_label">Star Mag:</label>
                                <input type="text" name="star_mag_input" id="star_mag_input">
                        </div>
                        <div class="form_row">
                                <label for="star_mag_cent" class="form_label">Star Cent:</label>
                                <input type="text" name="star_mag_cent" id="star_cent_input">
                        </div>
                        <div class="form_row">
                            <label for="star_story_input" class="form_label">Star Story:</label>
                        </div>
                        <div class="form_row_textarea">
                            <textarea type="text" name="star_story_input" id="star_story_input"></textarea>
                        </div>
                        <div class="form_row">
                            <button id="create_star_button" onclick="createStar();">Create</button>
                        </div>
                </div>
            </div>
            <div class="row">
                    <div class="spinner" id="spinner">
                            <div class="double-bounce1"></div>
                            <div class="double-bounce2"></div>
                    </div>
            </div>    
            <p>
                NOTE: Rinkeby may take some time before transaction is confirmed. Therefor, it may not be reflected immediately
            </p>
            <!--<button id="claim-button" onclick="claimButtonClicked()">Claim Star</button> -->
        </div>

        <script>    
            console.log("hello");
            if(typeof web3 != 'undefined') { 
                web3 = new Web3(web3.currentProvider) // what Metamask injected 
            } else {
                // Instantiate and set Ganache as your provider
                web3 = new Web3(new Web3.providers.HttpProvider("https://rinkeby.infura.io/v3/06ec1ae219754b23a2bed3fea410fec5"));
            }

            // The default (top) wallet account from a list of test accounts 
            web3.eth.defaultAccount = web3.eth.accounts[0];

            // The interface definition for your smart contract (the ABI) 
            var StarNotary = web3.eth.contract(
                [
                        {
                            "anonymous": false,
                            "inputs": [
                                {
                                    "indexed": true,
                                    "name": "owner",
                                    "type": "address"
                                },
                                {
                                    "indexed": true,
                                    "name": "operator",
                                    "type": "address"
                                },
                                {
                                    "indexed": false,
                                    "name": "approved",
                                    "type": "bool"
                                }
                            ],
                            "name": "ApprovalForAll",
                            "type": "event"
                        },
                        {
                            "constant": false,
                            "inputs": [
                                {
                                    "name": "to",
                                    "type": "address"
                                },
                                {
                                    "name": "tokenId",
                                    "type": "uint256"
                                }
                            ],
                            "name": "approve",
                            "outputs": [],
                            "payable": false,
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "anonymous": false,
                            "inputs": [
                                {
                                    "indexed": true,
                                    "name": "owner",
                                    "type": "address"
                                },
                                {
                                    "indexed": true,
                                    "name": "approved",
                                    "type": "address"
                                },
                                {
                                    "indexed": true,
                                    "name": "tokenId",
                                    "type": "uint256"
                                }
                            ],
                            "name": "Approval",
                            "type": "event"
                        },
                        {
                            "anonymous": false,
                            "inputs": [
                                {
                                    "indexed": true,
                                    "name": "from",
                                    "type": "address"
                                },
                                {
                                    "indexed": true,
                                    "name": "to",
                                    "type": "address"
                                },
                                {
                                    "indexed": true,
                                    "name": "tokenId",
                                    "type": "uint256"
                                }
                            ],
                            "name": "Transfer",
                            "type": "event"
                        },
                        {
                            "constant": false,
                            "inputs": [
                                {
                                    "name": "_tokenId",
                                    "type": "uint256"
                                }
                            ],
                            "name": "buyStar",
                            "outputs": [],
                            "payable": true,
                            "stateMutability": "payable",
                            "type": "function"
                        },
                        {
                            "constant": false,
                            "inputs": [
                                {
                                    "name": "_name",
                                    "type": "string"
                                },
                                {
                                    "name": "_tokenId",
                                    "type": "uint256"
                                },
                                {
                                    "name": "dec",
                                    "type": "string"
                                },
                                {
                                    "name": "mag",
                                    "type": "string"
                                },
                                {
                                    "name": "cent",
                                    "type": "string"
                                },
                                {
                                    "name": "story",
                                    "type": "string"
                                }
                            ],
                            "name": "createStar",
                            "outputs": [],
                            "payable": false,
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "constant": false,
                            "inputs": [
                                {
                                    "name": "_tokenId",
                                    "type": "uint256"
                                },
                                {
                                    "name": "_price",
                                    "type": "uint256"
                                }
                            ],
                            "name": "putStarUpForSale",
                            "outputs": [],
                            "payable": false,
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "constant": false,
                            "inputs": [
                                {
                                    "name": "from",
                                    "type": "address"
                                },
                                {
                                    "name": "to",
                                    "type": "address"
                                },
                                {
                                    "name": "tokenId",
                                    "type": "uint256"
                                }
                            ],
                            "name": "safeTransferFrom",
                            "outputs": [],
                            "payable": false,
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "constant": false,
                            "inputs": [
                                {
                                    "name": "from",
                                    "type": "address"
                                },
                                {
                                    "name": "to",
                                    "type": "address"
                                },
                                {
                                    "name": "tokenId",
                                    "type": "uint256"
                                },
                                {
                                    "name": "_data",
                                    "type": "bytes"
                                }
                            ],
                            "name": "safeTransferFrom",
                            "outputs": [],
                            "payable": false,
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "constant": false,
                            "inputs": [
                                {
                                    "name": "to",
                                    "type": "address"
                                },
                                {
                                    "name": "approved",
                                    "type": "bool"
                                }
                            ],
                            "name": "setApprovalForAll",
                            "outputs": [],
                            "payable": false,
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "constant": false,
                            "inputs": [
                                {
                                    "name": "from",
                                    "type": "address"
                                },
                                {
                                    "name": "to",
                                    "type": "address"
                                },
                                {
                                    "name": "tokenId",
                                    "type": "uint256"
                                }
                            ],
                            "name": "transferFrom",
                            "outputs": [],
                            "payable": false,
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [
                                {
                                    "name": "",
                                    "type": "uint256"
                                }
                            ],
                            "name": "allStars",
                            "outputs": [
                                {
                                    "name": "",
                                    "type": "uint256"
                                }
                            ],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [],
                            "name": "allStarsLength",
                            "outputs": [
                                {
                                    "name": "",
                                    "type": "uint256"
                                }
                            ],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [
                                {
                                    "name": "owner",
                                    "type": "address"
                                }
                            ],
                            "name": "balanceOf",
                            "outputs": [
                                {
                                    "name": "",
                                    "type": "uint256"
                                }
                            ],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [
                                {
                                    "name": "tokenId",
                                    "type": "uint256"
                                }
                            ],
                            "name": "getApproved",
                            "outputs": [
                                {
                                    "name": "",
                                    "type": "address"
                                }
                            ],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [
                                {
                                    "name": "owner",
                                    "type": "address"
                                },
                                {
                                    "name": "operator",
                                    "type": "address"
                                }
                            ],
                            "name": "isApprovedForAll",
                            "outputs": [
                                {
                                    "name": "",
                                    "type": "bool"
                                }
                            ],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [
                                {
                                    "name": "tokenId",
                                    "type": "uint256"
                                }
                            ],
                            "name": "ownerOf",
                            "outputs": [
                                {
                                    "name": "",
                                    "type": "address"
                                }
                            ],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [
                                {
                                    "name": "",
                                    "type": "uint256"
                                }
                            ],
                            "name": "starsAvailable",
                            "outputs": [
                                {
                                    "name": "",
                                    "type": "uint256"
                                }
                            ],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [
                                {
                                    "name": "",
                                    "type": "uint256"
                                }
                            ],
                            "name": "starsForSale",
                            "outputs": [
                                {
                                    "name": "",
                                    "type": "uint256"
                                }
                            ],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [
                                {
                                    "name": "interfaceId",
                                    "type": "bytes4"
                                }
                            ],
                            "name": "supportsInterface",
                            "outputs": [
                                {
                                    "name": "",
                                    "type": "bool"
                                }
                            ],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [
                                {
                                    "name": "",
                                    "type": "uint256"
                                }
                            ],
                            "name": "tokenIdToCoordinates",
                            "outputs": [
                                {
                                    "name": "dec",
                                    "type": "string"
                                },
                                {
                                    "name": "mag",
                                    "type": "string"
                                },
                                {
                                    "name": "cent",
                                    "type": "string"
                                }
                            ],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [
                                {
                                    "name": "",
                                    "type": "uint256"
                                }
                            ],
                            "name": "tokenIdToOwners",
                            "outputs": [
                                {
                                    "name": "",
                                    "type": "address"
                                }
                            ],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [
                                {
                                    "name": "",
                                    "type": "uint256"
                                }
                            ],
                            "name": "tokenIdToStar",
                            "outputs": [
                                {
                                    "name": "name",
                                    "type": "string"
                                },
                                {
                                    "name": "story",
                                    "type": "string"
                                }
                            ],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [
                                {
                                    "name": "_tokenId",
                                    "type": "uint256"
                                }
                            ],
                            "name": "tokenIdToStarInfo",
                            "outputs": [
                                {
                                    "name": "name",
                                    "type": "string"
                                },
                                {
                                    "name": "story",
                                    "type": "string"
                                },
                                {
                                    "name": "cent",
                                    "type": "string"
                                },
                                {
                                    "name": "dec",
                                    "type": "string"
                                },
                                {
                                    "name": "mag",
                                    "type": "string"
                                }
                            ],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        }
                    ]
            );
            // Grab the contract at specified deployed address with the interface defined by the ABI
            var starNotary = StarNotary.at('0x54ee0ed5Cb936e579c22C747A79e606d8eE0eB4E');

            
            getStarLength().then((num_of_stars)=>{
                   
                console.log("results", num_of_stars);
                getAllStarId(num_of_stars).then((result)=>{
                    
                    console.log("result size", result.length);
                    generateStarIdHTMLList(result);

                    /*
                    getAllStarData(result).then(stars=>{
                        getStarsCoords(stars).then(stars=>{
                            generateStarTable(stars);
                        })
                    })*/
                })
            });

           
            

            function getStarLength(){
                
              return new Promise((resolve, reject)=>starNotary.allStarsLength(function(error, result){
                    if(!error){
                        resolve(result.toNumber())
                    } else {
                        reject(error);
                    }
                }));

            }

            function getAllStarId(length){
                let starId = [];
                return new Promise((resolve, reject)=>{
                    for(let i=0; i<length; i++){
                        starNotary.allStars(i, function(error, result){
                            if(!error){
                                starId.push(result.toNumber());
                                if(i === length - 1){
                                    resolve(starId);
                                }
                                    
                            }else{
                                console.log("error");
                            }
                        })
                       
                    }
                    
                })  
            }

            function getAllStarData(starIds){
                let stars = [];
                return new Promise((resolve, reject) => {
                    for(let i=0; i < starIds.length; i++){
                        starNotary.tokenIdToStar(starIds[i], function(error, result){
                            if(!error){
                                stars.push(new Star(starIds[i], result[0], result[1]))
                                if(i === starIds.length - 1){
                                    resolve(stars);
                                }
                                    
                            }else{
                                console.log(error);
                            }
                        })
                    }
                });
            }
            

            function getStarsCoords(stars){
                return new Promise((resolve, reject)=>{
                    for(let i=0; i<stars.length; i++){
                        starNotary.tokenIdToCoordinates(stars[i].id, function(error, result){
                            if(!error){
                                stars[i].dec = result[0];
                                stars[i].mag = result[1];
                                stars[i].cent = result[2];
                                if(i == stars.length - 1){
                                    resolve(stars);
                                }
                                    
                            }else {
                                console.log(error)
                            }
                        })
                    }
                })
            }


            function getStarData(starId){
                return new Promise((resolve, reject)=>{
                    starNotary.tokenIdToStar(starId, function(error, result){
                        if(!error){
                            resolve(result);
                        }else {
                            reject(error);
                        }
                    });
                });
            }


            function generateStarIdHTMLList(starIds){
                console.log("generating HTML");
                for(let i=0; i<starIds.length; i++){
                    var node = document.createElement("li");
                    node.className = "star_id";
                    var anchor = document.createElement("a");
                    anchor.href = "#";
                    anchor.className="button_link";
                    anchor.onclick = ()=>{ getStarInfo(starIds[i])};
                    var textNode = document.createTextNode(starIds[i]);
                    anchor.appendChild(textNode);
                    node.appendChild(anchor);
                    document.getElementById("star_list").appendChild(node);
                }
            }


            function getStarInfo(starId){
                starNotary.tokenIdToStarInfo(starId, (error, result)=>{
                    if(!error){
                        document.getElementById("coords_title").innerText = "Coordinates";
                        document.getElementById("star_name").innerText = result[0];
                        document.getElementById("star_story").innerText = result[1];
                        document.getElementById("star_dec").innerText = result[2];
                        document.getElementById("star_mag").innerText = result[3];
                        document.getElementById("star_cent").innerText = result[4];
                    }else{
                        alert("there has been an error:", error);
                    }
                })
            }
            

            function createStar(){
                
                let id = document.getElementById("star_id_input").value;
                let name = document.getElementById("star_name_input").value;
                let dec = document.getElementById("star_dec_input").value;
                let mag = document.getElementById("star_mag_input").value;
                let cent = document.getElementById("star_cent_input").value;
                let story = document.getElementById("star_story_input").value;
                let spinner = document.getElementById("spinner");
                spinner.style.display = "block";
                
                if(checkInput(id, name, dec, mag, cent, story)){
                    starNotary.createStar(name, id, dec, mag, cent, story, (error, result)=>{
                        if(!error){
                             spinner.style.display = "none";
                             window.location.reload();
                        }else{
                            console.log("error");
                        }
                    })
                   
                }else{
                    spinner.style.display = "none";
                    alert("ERROR: EMPTY REQUIRED FIELDS");
                }
                

            }

            function checkInput(id, name, dec, mag, cent, story){
                

                if(id === '' || name === '' || dec === '' || mag === '' || cent === '' || story === '')
                    return false;
                else
                    return true;


            }



            /*
            console.log(starNotary.allStars(0, (error, result)=>{
                console.log("resolved", result.toNumber());
            }));*/

            

            /*
            starNotary.tokenIdToStarInfo("00023123", function(error, result){
                if(!error){
                    console.log("star story: " + result[1]);
                } else {
                    console.log(error);
                }
            })*/
            /*

            
            // Get and display star name
            /*
            starNotary.starName(function (error, result) {
                if (!error) {
                    document.getElementById('star-name').innerText = result
                } else { 
                    console.log(error);
                }
            });

            // Get and display star owner
            starNotary.starOwner(function (error, result) {
                if (!error) {
                    document.getElementById('star-owner').innerText = result
                } else { 
                    console.log(error);
                }
            });*/

            // Enable claim button being clicked
            /*
            function claimButtonClicked() { 
                web3.eth.getAccounts(function(error, accounts) { 
                    if (error) { 
                        console.log(error)
                        return
                    }
                    var account = accounts[0]
                    starNotary.claimStar(function (error, result) {
                        if (!error) {
                            var starClaimedEvent = starNotary.starClaimed({from: account});
                            starClaimedEvent.watch(function(error, result) {
                                if (!error) {
                                    location.reload();
                                } else {
                                    console.log('watching for star claimed event is failing');
                                }
                            });
                        } else { 
                            console.log(error);
                        }
                    });
                   
                })
            }*/
        </script>
    </body>
</html>